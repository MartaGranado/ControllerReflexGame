<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nintendo reflex</title>
  <link rel="stylesheet" href="styles/nintendo.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游꿡</text></svg>">
</head>

<!-- Navbar -->
<nav id="navbar">
  <a href="index.html" id="homeLink">游꿡</a>
  <select id="languageSelector" onchange="changeLanguage(this.value)">
    <option value="es" selected>Espa침ol</option>
    <option value="en">English</option>
  </select>
</nav>

<body>
  <div id="menu">
    <h1 id="title">Reflejos Nintendo</h1>
    <button class="easy" onclick="startGame('easy')" id="easyBtn">Modo F치cil</button>
    <button class="hard" onclick="startGame('hard')" id="hardBtn">Modo Dif칤cil</button>
  </div>

  <div id="game">
    <button onclick="goToMenu()" id="menuBtn">Men칰</button>
    <h1 id="gameTitle">Reflejos Nintendo</h1>
    <div id="buttonContainer" class="easy">
      <div id="A" class="button">A</div>
      <div id="B" class="button">B</div>
      <div id="X" class="button">X</div>
      <div id="Y" class="button">Y</div>
      <div id="targetButton"></div> <!-- Modo dif칤cil -->
    </div>
    <div id="score">Aciertos: 0</div>
    <div id="errors">Errores: 0</div>
    <div id="timer">Tiempo restante: 3.00s</div>
  </div>

  <script>
    const buttons = ['A', 'B', 'X', 'Y'];
    let currentButton = '';
    let score = 0;
    let errors = 0;
    const timeLimit = 3000;
    let timer, timerInterval;
    let lastPressTime = 0;
    const debounceTime = 300;
    let gameMode = 'easy';
    let gameRunning = false;
    let currentLang = 'es';

    const successSound = new Audio('./audio/success.mp3');
    const failSound = new Audio('./audio/fail.mp3');

    const translations = {
      es: {
        title: 'Juego Reflejos Nintendo',
        easy: 'Modo F치cil',
        hard: 'Modo Dif칤cil',
        menu: 'Men칰',
        score: 'Aciertos',
        errors: 'Errores',
        timeLeft: 'Tiempo restante',
        gameOver: '춰Game Over! Puntuaci칩n final: '
      },
      en: {
        title: 'Nintendo Reflex Game',
        easy: 'Easy Mode',
        hard: 'Hard Mode',
        menu: 'Menu',
        score: 'Hits',
        errors: 'Errors',
        timeLeft: 'Time left',
        gameOver: 'Game Over! Final Score: '
      }
    };

    function startGame(mode) {
      gameRunning = true;
      gameMode = mode;
      document.getElementById('menu').style.display = 'none';
      document.getElementById('game').style.display = 'block';
      document.getElementById('buttonContainer').className = mode;
      score = 0;
      errors = 0;
      updateUI();
      nextRound();
      requestAnimationFrame(checkGamepad);
    }

    function goToMenu() {
      gameRunning = false;
      clearTimeout(timer);
      clearInterval(timerInterval);
      document.getElementById('game').style.display = 'none';
      document.getElementById('menu').style.display = 'flex';
    }

    function updateUI() {
      document.getElementById('score').textContent = `${translations[currentLang].score}: ${score}`;
      document.getElementById('errors').textContent = `${translations[currentLang].errors}: ${errors}`;
    }

    function nextRound() {
      if (errors >= 5) {
        endGame();
        return;
      }
      currentButton = buttons[Math.floor(Math.random() * buttons.length)];
      highlightButton(currentButton);
      startTimer();
    }

    function highlightButton(button) {
      const allButtons = document.querySelectorAll('.button');
      if (gameMode === 'easy') {
        allButtons.forEach(btn => btn.style.opacity = '0.5');
        document.getElementById(button).style.opacity = '1';
        document.getElementById('targetButton').textContent = '';
      } else {
        allButtons.forEach(btn => btn.style.opacity = '0.5');
        document.getElementById('targetButton').textContent = button;
      }
    }

    function startTimer() {
      clearInterval(timerInterval);
      clearTimeout(timer);
      let remainingTime = timeLimit;
      document.getElementById('timer').textContent = `${translations[currentLang].timeLeft}: ${(remainingTime / 1000).toFixed(2)}s`;

      timerInterval = setInterval(() => {
        remainingTime -= 50;
        document.getElementById('timer').textContent = `${translations[currentLang].timeLeft}: ${(remainingTime / 1000).toFixed(2)}s`;
        if (remainingTime <= 0) {
          clearInterval(timerInterval);
        }
      }, 50);

      timer = setTimeout(() => handleFail(), timeLimit);
    }

    function handleSuccess() {
      clearTimeout(timer);
      clearInterval(timerInterval);
      successSound.play();
      score++;
      updateUI();
      nextRound();
    }

    function handleFail() {
      clearTimeout(timer);
      clearInterval(timerInterval);
      failSound.play();
      errors++;
      updateUI();
      nextRound();
    }

    function endGame() {
      alert(`${translations[currentLang].gameOver} ${score}`);
      goToMenu();
    }

    function checkGamepad() {
        if (!gameRunning) return;

        const gamepads = navigator.getGamepads();
        
        if (gamepads[0]) {
            const gp = gamepads[0];
            
            // Check if the connected controller is a Nintendo controller (Switch or Joy-Con)
            if (gp.id.toLowerCase().includes("nintendo") || gp.id.toLowerCase().includes("joy-con")) {
            const buttonMap = { 0: 'A', 1: 'B', 2: 'X', 3: 'Y' };
            const currentTime = Date.now();

            gp.buttons.forEach((button, index) => {
                if (button.pressed && buttonMap[index]) {
                if (currentTime - lastPressTime > debounceTime) {
                    lastPressTime = currentTime;
                    if (buttonMap[index] === currentButton) {
                    handleSuccess();
                    } else {
                    handleFail();
                    }
                }
                }
            });
            } else {
            // If the connected controller isn't a Nintendo controller, stop the game and alert the user
            if (gameRunning) {
                alert("Este juego solo acepta controladores Nintendo.");
                goToMenu();
                setTimeout(() => {
                    location.reload(); // Refresh the page after the alert is dismissed
                }, 500); // Small delay to allow alert to close
            }
            }
        }
        window.requestAnimationFrame(checkGamepad);
        }


    function changeLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('language', lang); // <-- Save to localStorage
      document.getElementById('title').textContent = translations[lang].title;
      document.getElementById('gameTitle').textContent = translations[lang].title;
      document.getElementById('easyBtn').textContent = translations[lang].easy;
      document.getElementById('hardBtn').textContent = translations[lang].hard;
      document.getElementById('menuBtn').textContent = translations[lang].menu;
      updateUI();
      document.getElementById('timer').textContent = `${translations[lang].timeLeft}: 3.00s`;
      document.getElementById('languageSelector').value = lang; // Set the dropdown
    }
    window.addEventListener('load', () => {
      const savedLang = localStorage.getItem('language');
      if (savedLang && translations[savedLang]) {
        changeLanguage(savedLang);
      }
    });

  </script>

</body>

</html>
